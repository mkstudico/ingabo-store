<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - INGABO Store</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js"></script>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #ff6a00, #ff8c42);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .back-link {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        /* Main Form */
        .main-form {
            padding: 40px;
        }
        
        .form-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 22px;
            color: #ff6a00;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            font-weight: 600;
        }
        
        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 15px;
        }
        
        .form-label .required {
            color: #ff0000;
            margin-left: 3px;
        }
        
        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: #ff6a00;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23333' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 40px;
        }
        
        /* Multi-select for colors */
        .color-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 5px;
        }
        
        .color-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }
        
        .color-option:hover {
            border-color: #ff6a00;
        }
        
        .color-option.selected {
            border-color: #ff6a00;
            background: rgba(255, 106, 0, 0.05);
        }
        
        .color-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        
        /* Price Input */
        .price-input {
            position: relative;
        }
        
        .price-input .currency {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 500;
            color: #666;
        }
        
        .price-input input {
            padding-left: 45px;
        }
        
        /* Image Upload */
        .image-upload-container {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        
        .image-upload-container:hover {
            border-color: #ff6a00;
            background: white;
        }
        
        .image-upload-container.drag-over {
            border-color: #ff6a00;
            background: rgba(255, 106, 0, 0.05);
        }
        
        .upload-icon {
            font-size: 48px;
            color: #ff6a00;
            margin-bottom: 15px;
        }
        
        .upload-text {
            margin-bottom: 20px;
            color: #666;
        }
        
        .upload-text strong {
            color: #ff6a00;
        }
        
        .upload-button {
            background: #ff6a00;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            transition: background 0.3s ease;
        }
        
        .upload-button:hover {
            background: #e55f00;
        }
        
        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        /* Suggestion Code Display */
        .code-display {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .code-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        
        .code-value {
            font-family: monospace;
            font-size: 18px;
            color: #333;
            font-weight: 600;
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            padding: 30px 0;
            border-top: 2px solid #f0f0f0;
        }
        
        .submit-button,
        .reset-button {
            padding: 16px 40px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 180px;
        }
        
        .submit-button {
            background: linear-gradient(135deg, #ff6a00, #ff8c42);
            color: white;
        }
        
        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 106, 0, 0.3);
        }
        
        .submit-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .reset-button {
            background: white;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        
        .reset-button:hover {
            border-color: #666;
            color: #333;
        }
        
        /* Status Messages */
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: flex;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: flex;
        }
        
        .status-message.loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: flex;
        }
        
        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                box-shadow: none;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .main-form {
                padding: 25px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            
            .submit-button,
            .reset-button {
                width: 100%;
                min-width: auto;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            .color-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <a href="index.html" class="back-link">
                <i class='bx bx-arrow-back'></i> Back to Store
            </a>
            <h1>Add New Product</h1>
            <p>Fill in the product details below. All fields are required for proper personalization.</p>
        </div>
        
        <!-- Main Form -->
        <div class="main-form">
            <!-- Status Message -->
            <div id="statusMessage" class="status-message"></div>
            
            <!-- Basic Information -->
            <div class="form-section">
                <h2 class="section-title">Basic Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Product Name <span class="required">*</span></label>
                        <input type="text" class="form-input" id="productName" placeholder="Enter product name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Category <span class="required">*</span></label>
                        <select class="form-select" id="productCategory" required>
                            <option value="">Select a category</option>
                            <option value="Shoes">Shoes</option>
                            <option value="T-shirts">T-shirts</option>
                            <option value="Pants">Pants</option>
                            <option value="Watches">Watches</option>
                            <option value="Necklace">Necklace</option>
                            <option value="Bracelets">Bracelets</option>
                            <option value="Caps">Caps</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Description <span class="required">*</span></label>
                        <textarea class="form-textarea" id="productDescription" placeholder="Enter detailed product description..." required></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Product Metrics -->
            <div class="form-section">
                <h2 class="section-title">Personalization Metrics</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Department <span class="required">*</span></label>
                        <select class="form-select" id="productDepartment" required>
                            <option value="">Select department</option>
                            <option value="Men">Men</option>
                            <option value="Women">Women</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Size <span class="required">*</span></label>
                        <select class="form-select" id="productSize" required>
                            <option value="">Select size</option>
                            <option value="Small">Small</option>
                            <option value="Medium">Medium</option>
                            <option value="Large">Large</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Age Group <span class="required">*</span></label>
                        <select class="form-select" id="productAge" required>
                            <option value="">Select age group</option>
                            <option value="All">All</option>
                            <option value="Young">Young (Under 25)</option>
                            <option value="Teens">Teens (13-19)</option>
                            <option value="Adult">Adult (20-60)</option>
                            <option value="Old">Old (60+)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Status <span class="required">*</span></label>
                        <select class="form-select" id="productStatus" required>
                            <option value="">Select status</option>
                            <option value="New">New</option>
                            <option value="Used">Used</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Color <span class="required">*</span> (Select all that apply)</label>
                        <div class="color-options" id="colorOptions">
                            <!-- Color options will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pricing & Images -->
            <div class="form-section">
                <h2 class="section-title">Pricing & Images</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Price (RWF) <span class="required">*</span></label>
                        <div class="price-input">
                            <span class="currency">RWF</span>
                            <input type="number" class="form-input" id="productPrice" min="500" max="100000" step="100" placeholder="Enter price" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Wealth Category</label>
                        <select class="form-select" id="productWealth">
                            <option value="">Auto-calculate from price</option>
                            <option value="Poor">Poor (500-20,000 RWF)</option>
                            <option value="Moderate">Moderate (20,000-50,000 RWF)</option>
                            <option value="Rich">Rich (50,000-100,000 RWF)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Original Price (RWF)</label>
                        <div class="price-input">
                            <span class="currency">RWF</span>
                            <input type="number" class="form-input" id="originalPrice" min="500" max="200000" step="100" placeholder="Original price (if on sale)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Discount (%)</label>
                        <input type="number" class="form-input" id="productDiscount" min="0" max="100" step="1" placeholder="Optional discount percentage">
                    </div>
                    
                    <div class="form-group full-width">
                        <label class="form-label">Product Images <span class="required">*</span></label>
                        <div class="image-upload-container" id="imageUploadContainer">
                            <div class="upload-icon">
                                <i class='bx bx-cloud-upload'></i>
                            </div>
                            <div class="upload-text">
                                <strong>Click to upload</strong> or drag and drop
                            </div>
                            <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                            <button type="button" class="upload-button" id="uploadButton">
                                <i class='bx bx-image-add'></i> Choose Images
                            </button>
                            <p style="margin-top: 15px; color: #999; font-size: 14px;">
                                Upload multiple images (Max 5, Max 2MB each)
                            </p>
                        </div>
                        
                        <div class="image-preview" id="imagePreview"></div>
                    </div>
                </div>
            </div>
            
            <!-- Generated Suggestion Code -->
            <div class="form-section">
                <h2 class="section-title">Suggestion Code</h2>
                <div class="code-display">
                    <div class="code-label">This code will be automatically generated for personalized recommendations:</div>
                    <div class="code-value" id="suggestionCodeDisplay">A-B-C+D+E-D-E-F-G</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        Format: Category-Department-Color-Size-Age-Status-Wealth
                    </div>
                </div>
            </div>
            
            <!-- Form Actions -->
            <div class="form-actions">
                <button type="button" class="submit-button" id="submitButton" disabled>
                    <span id="submitText">Add Product</span>
                    <div class="spinner" id="submitSpinner" style="display: none;"></div>
                </button>
                <button type="button" class="reset-button" id="resetButton">
                    <i class='bx bx-reset'></i> Reset Form
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAQsQAEGPdFY2gKRBpC3crZTSEzUGQ4CKE",
            authDomain: "ingabo-store.firebaseapp.com",
            projectId: "ingabo-store",
            storageBucket: "ingabo-store.firebasestorage.app",
            messagingSenderId: "1059301382626",
            appId: "1:1059301382626:web:98f0a8cebbeccbc21f41bb",
            measurementId: "G-QSXTGP9R1Q"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // ==================== GLOBAL VARIABLES ====================
        const IMGBB_API_KEY = '7275819de7bfd56f03b903f483157d22';
        let uploadedImages = [];
        let selectedColors = [];

        // ==================== COLOR OPTIONS ====================
        const colorOptions = [
            { name: 'White', color: '#FFFFFF' },
            { name: 'Black', color: '#000000' },
            { name: 'Blue', color: '#0000FF' },
            { name: 'Green', color: '#008000' },
            { name: 'Red', color: '#FF0000' },
            { name: 'Yellow', color: '#FFFF00' },
            { name: 'Chocolate', color: '#D2691E' },
            { name: 'Purple', color: '#800080' },
            { name: 'Orange', color: '#FFA500' },
            { name: 'Sky-blue', color: '#87CEEB' },
            { name: 'Reddish', color: '#FF6347' },
            { name: 'Pink', color: '#FFC0CB' }
        ];

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            initializeColorOptions();
            setupEventListeners();
            updateSubmitButton();
            analytics.logEvent('add_product_page_view');
        });

        // ==================== COLOR SELECTION ====================
        function initializeColorOptions() {
            const container = document.getElementById('colorOptions');
            container.innerHTML = '';
            
            colorOptions.forEach(color => {
                const option = document.createElement('div');
                option.className = 'color-option';
                option.innerHTML = `
                    <div class="color-box" style="background-color: ${color.color};"></div>
                    <span>${color.name}</span>
                `;
                
                option.addEventListener('click', () => {
                    option.classList.toggle('selected');
                    const index = selectedColors.indexOf(color.name);
                    if (index === -1) {
                        selectedColors.push(color.name);
                    } else {
                        selectedColors.splice(index, 1);
                    }
                    updateSuggestionCode();
                    updateSubmitButton();
                });
                
                container.appendChild(option);
            });
        }

        // ==================== SUGGESTION CODE GENERATION ====================
        function generateSuggestionCode() {
            const category = document.getElementById('productCategory').value;
            const department = document.getElementById('productDepartment').value;
            const size = document.getElementById('productSize').value;
            const age = document.getElementById('productAge').value;
            const status = document.getElementById('productStatus').value;
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            
            // Define metric mappings
            const metricMappings = {
                category: {
                    'Shoes': 'A',
                    'T-shirts': 'B',
                    'Pants': 'C',
                    'Watches': 'D',
                    'Necklace': 'E',
                    'Bracelets': 'F',
                    'Caps': 'G'
                },
                department: {
                    'Men': 'A',
                    'Women': 'B'
                },
                color: {
                    'White': 'A',
                    'Black': 'B',
                    'Blue': 'C',
                    'Green': 'D',
                    'Red': 'E',
                    'Yellow': 'F',
                    'Chocolate': 'G',
                    'Purple': 'H',
                    'Orange': 'I',
                    'Sky-blue': 'J',
                    'Reddish': 'K',
                    'Pink': 'L'
                },
                size: {
                    'Small': 'A',
                    'Medium': 'B',
                    'Large': 'C'
                },
                age: {
                    'All': 'A',
                    'Young': 'B',
                    'Teens': 'C',
                    'Adult': 'D',
                    'Old': 'E'
                },
                status: {
                    'New': 'A',
                    'Used': 'B'
                },
                wealth: {
                    'Poor': 'A',
                    'Moderate': 'B',
                    'Rich': 'C'
                }
            };

            // Start building code
            let code = '';
            
            // Category
            code += (category && metricMappings.category[category]) || 'X';
            code += '-';
            
            // Department
            code += (department && metricMappings.department[department]) || 'X';
            code += '-';
            
            // Color (multiple selections)
            if (selectedColors.length > 0) {
                code += selectedColors.map(c => metricMappings.color[c] || 'X').join('+');
            } else {
                code += 'X';
            }
            code += '-';
            
            // Size
            code += (size && metricMappings.size[size]) || 'X';
            code += '-';
            
            // Age
            code += (age && metricMappings.age[age]) || 'X';
            code += '-';
            
            // Status
            code += (status && metricMappings.status[status]) || 'X';
            code += '-';
            
            // Wealth category
            let wealthCategory = '';
            if (document.getElementById('productWealth').value) {
                wealthCategory = document.getElementById('productWealth').value;
            } else {
                // Auto-calculate from price
                if (price >= 500 && price <= 20000) wealthCategory = 'Poor';
                else if (price > 20000 && price <= 50000) wealthCategory = 'Moderate';
                else if (price > 50000 && price <= 100000) wealthCategory = 'Rich';
            }
            
            code += (wealthCategory && metricMappings.wealth[wealthCategory]) || 'X';
            
            return code;
        }

        function updateSuggestionCode() {
            const code = generateSuggestionCode();
            document.getElementById('suggestionCodeDisplay').textContent = code;
        }

        // ==================== IMAGE UPLOAD ====================
        function setupEventListeners() {
            // Upload button
            document.getElementById('uploadButton').addEventListener('click', () => {
                document.getElementById('imageUpload').click();
            });

            // File input change
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

            // Drag and drop
            const uploadContainer = document.getElementById('imageUploadContainer');
            uploadContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadContainer.classList.add('drag-over');
            });

            uploadContainer.addEventListener('dragleave', () => {
                uploadContainer.classList.remove('drag-over');
            });

            uploadContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadContainer.classList.remove('drag-over');
                
                const files = Array.from(e.dataTransfer.files);
                handleImageFiles(files);
            });

            // Form inputs for suggestion code updates
            const inputsForCode = [
                'productCategory', 'productDepartment', 'productSize',
                'productAge', 'productStatus', 'productPrice', 'productWealth'
            ];
            
            inputsForCode.forEach(inputId => {
                document.getElementById(inputId).addEventListener('change', updateSuggestionCode);
            });

            // Reset button
            document.getElementById('resetButton').addEventListener('click', resetForm);

            // Submit button
            document.getElementById('submitButton').addEventListener('click', submitProduct);

            // Input validation for submit button
            const requiredInputs = [
                'productName', 'productCategory', 'productDescription',
                'productDepartment', 'productSize', 'productAge',
                'productStatus', 'productPrice'
            ];
            
            requiredInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('input', updateSubmitButton);
            });
        }

        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            handleImageFiles(files);
        }

        function handleImageFiles(files) {
            // Validate files
            const validFiles = files.filter(file => {
                if (file.size > 2 * 1024 * 1024) {
                    showMessage('error', `File ${file.name} exceeds 2MB limit`);
                    return false;
                }
                if (!file.type.startsWith('image/')) {
                    showMessage('error', `File ${file.name} is not an image`);
                    return false;
                }
                return true;
            });

            // Check total images limit
            if (uploadedImages.length + validFiles.length > 5) {
                showMessage('error', 'Maximum 5 images allowed');
                return;
            }

            // Upload each file
            validFiles.forEach(file => {
                uploadImageToImgBB(file);
            });
        }

        async function uploadImageToImgBB(file) {
            const formData = new FormData();
            formData.append('key', IMGBB_API_KEY);
            formData.append('image', file);

            try {
                const response = await fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    uploadedImages.push({
                        url: data.data.url,
                        thumb: data.data.thumb.url,
                        name: file.name
                    });
                    updateImagePreview();
                    updateSubmitButton();
                    showMessage('success', `Image ${file.name} uploaded successfully`);
                } else {
                    throw new Error(data.error?.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Image upload error:', error);
                showMessage('error', `Failed to upload ${file.name}: ${error.message}`);
            }
        }

        function updateImagePreview() {
            const container = document.getElementById('imagePreview');
            container.innerHTML = '';
            
            uploadedImages.forEach((image, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.innerHTML = `
                    <img src="${image.thumb}" alt="Preview ${index + 1}">
                    <button type="button" class="remove-image" data-index="${index}">
                        <i class='bx bx-x'></i>
                    </button>
                `;
                
                container.appendChild(previewItem);
            });

            // Add remove event listeners
            document.querySelectorAll('.remove-image').forEach(button => {
                button.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    uploadedImages.splice(index, 1);
                    updateImagePreview();
                    updateSubmitButton();
                });
            });
        }

        // ==================== FORM VALIDATION ====================
        function validateForm() {
            const requiredFields = [
                { id: 'productName', name: 'Product Name' },
                { id: 'productCategory', name: 'Category' },
                { id: 'productDescription', name: 'Description' },
                { id: 'productDepartment', name: 'Department' },
                { id: 'productSize', name: 'Size' },
                { id: 'productAge', name: 'Age Group' },
                { id: 'productStatus', name: 'Status' },
                { id: 'productPrice', name: 'Price' }
            ];

            for (const field of requiredFields) {
                const element = document.getElementById(field.id);
                if (!element.value.trim()) {
                    showMessage('error', `${field.name} is required`);
                    element.focus();
                    return false;
                }
            }

            // Validate price range
            const price = parseInt(document.getElementById('productPrice').value);
            if (price < 500 || price > 100000) {
                showMessage('error', 'Price must be between 500 and 100,000 RWF');
                document.getElementById('productPrice').focus();
                return false;
            }

            // Validate colors selected
            if (selectedColors.length === 0) {
                showMessage('error', 'Please select at least one color');
                return false;
            }

            // Validate images
            if (uploadedImages.length === 0) {
                showMessage('error', 'Please upload at least one product image');
                return false;
            }

            // Validate original price if provided
            const originalPrice = document.getElementById('originalPrice').value;
            if (originalPrice && parseInt(originalPrice) <= price) {
                showMessage('error', 'Original price must be higher than sale price');
                return false;
            }

            return true;
        }

        function updateSubmitButton() {
            const button = document.getElementById('submitButton');
            const hasRequiredData = 
                document.getElementById('productName').value.trim() &&
                document.getElementById('productCategory').value &&
                document.getElementById('productDescription').value.trim() &&
                document.getElementById('productDepartment').value &&
                document.getElementById('productSize').value &&
                document.getElementById('productAge').value &&
                document.getElementById('productStatus').value &&
                document.getElementById('productPrice').value &&
                selectedColors.length > 0 &&
                uploadedImages.length > 0;
            
            button.disabled = !hasRequiredData;
        }

        // ==================== FORM SUBMISSION ====================
        async function submitProduct() {
            if (!validateForm()) return;

            // Show loading state
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            submitButton.disabled = true;
            submitText.textContent = 'Adding Product...';
            submitSpinner.style.display = 'block';
            
            showMessage('loading', 'Adding product to database...');

            try {
                // Calculate discount percentage if original price provided
                const price = parseInt(document.getElementById('productPrice').value);
                const originalPriceInput = document.getElementById('originalPrice').value;
                const discountInput = document.getElementById('productDiscount').value;
                
                let discount = 0;
                let originalPrice = price;
                
                if (originalPriceInput) {
                    originalPrice = parseInt(originalPriceInput);
                    discount = Math.round((1 - price / originalPrice) * 100);
                } else if (discountInput) {
                    discount = parseInt(discountInput);
                    originalPrice = Math.round(price / (1 - discount / 100));
                }

                // Determine wealth category
                let wealthCategory = document.getElementById('productWealth').value;
                if (!wealthCategory) {
                    if (price >= 500 && price <= 20000) wealthCategory = 'Poor';
                    else if (price > 20000 && price <= 50000) wealthCategory = 'Moderate';
                    else if (price > 50000 && price <= 100000) wealthCategory = 'Rich';
                    else wealthCategory = 'Moderate';
                }

                // Prepare product data
                const productData = {
                    name: document.getElementById('productName').value.trim(),
                    description: document.getElementById('productDescription').value.trim(),
                    category: document.getElementById('productCategory').value,
                    department: document.getElementById('productDepartment').value,
                    color: selectedColors,
                    size: document.getElementById('productSize').value,
                    age: document.getElementById('productAge').value,
                    status: document.getElementById('productStatus').value,
                    wealth: wealthCategory,
                    price: price,
                    originalPrice: originalPriceInput ? originalPrice : null,
                    discount: discount > 0 ? discount : null,
                    images: uploadedImages.map(img => img.url),
                    suggestionCode: generateSuggestionCode(),
                    active: true,
                    featured: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // Save to Firestore
                const docRef = await db.collection('products').add(productData);
                
                // Log analytics event
                analytics.logEvent('product_added', {
                    product_id: docRef.id,
                    category: productData.category,
                    price: productData.price
                });

                // Show success message
                showMessage('success', `Product added successfully! ID: ${docRef.id}`);
                
                // Reset form after 2 seconds
                setTimeout(() => {
                    resetForm();
                    showMessage('success', 'Form reset. You can add another product.');
                }, 2000);

            } catch (error) {
                console.error('Error adding product:', error);
                showMessage('error', `Failed to add product: ${error.message}`);
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitText.textContent = 'Add Product';
                submitSpinner.style.display = 'none';
            }
        }

        // ==================== FORM RESET ====================
        function resetForm() {
            // Reset all form fields
            document.getElementById('productName').value = '';
            document.getElementById('productCategory').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productDepartment').value = '';
            document.getElementById('productSize').value = '';
            document.getElementById('productAge').value = '';
            document.getElementById('productStatus').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productWealth').value = '';
            document.getElementById('originalPrice').value = '';
            document.getElementById('productDiscount').value = '';
            
            // Reset colors
            selectedColors = [];
            document.querySelectorAll('.color-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Reset images
            uploadedImages = [];
            updateImagePreview();
            
            // Reset suggestion code display
            updateSuggestionCode();
            
            // Reset submit button
            updateSubmitButton();
            
            // Clear status message
            document.getElementById('statusMessage').className = 'status-message';
        }

        // ==================== STATUS MESSAGES ====================
        function showMessage(type, message) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.className = `status-message ${type}`;
            
            let icon = '';
            switch(type) {
                case 'success':
                    icon = '<i class="bx bx-check-circle"></i>';
                    break;
                case 'error':
                    icon = '<i class="bx bx-error-circle"></i>';
                    break;
                case 'loading':
                    icon = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div>';
                    break;
            }
            
            statusElement.innerHTML = `${icon} ${message}`;
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.className = 'status-message';
                }, 5000);
            }
        }

        // ==================== REAL-TIME VALIDATION ====================
        // Add input validation for better UX
        document.getElementById('productPrice').addEventListener('input', function() {
            const price = parseInt(this.value) || 0;
            const wealthSelect = document.getElementById('productWealth');
            
            if (price < 500 || price > 100000) {
                this.style.borderColor = '#ff0000';
                wealthSelect.value = '';
            } else {
                this.style.borderColor = '#e0e0e0';
                // Auto-update wealth category if not manually set
                if (!wealthSelect.value) {
                    if (price >= 500 && price <= 20000) wealthSelect.value = 'Poor';
                    else if (price > 20000 && price <= 50000) wealthSelect.value = 'Moderate';
                    else if (price > 50000 && price <= 100000) wealthSelect.value = 'Rich';
                    updateSuggestionCode();
                }
            }
        });

        document.getElementById('originalPrice').addEventListener('input', function() {
            const originalPrice = parseInt(this.value) || 0;
            const price = parseInt(document.getElementById('productPrice').value) || 0;
            
            if (originalPrice && originalPrice <= price) {
                this.style.borderColor = '#ff0000';
            } else {
                this.style.borderColor = '#e0e0e0';
            }
        });
    </script>
</body>
</html>
