<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INGABO Online Shop</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 for compatibility (FIXED) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
    <style>
        /* ... (Keep all existing CSS styles exactly as they are) ... */
        /* The CSS remains unchanged - just fix the Firebase version and JS errors */
    </style>
</head>
<body>
    <!-- Paused Mode Overlay -->
    <div class="paused-overlay" id="pausedOverlay">
        <div>WEBSITE IS TEMPORARILY PAUSED. PLEASE CHECK BACK SOON.</div>
    </div>
    
    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcementBanner">
        <div class="announcement-content" id="announcementContent"></div>
    </div>
    
    <div class="container">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-content">
                <div class="logo-area">
                    <img src="https://i.ibb.co/1fjd5Ncn/logo.png" alt="INGABO Logo" class="logo-img">
                    <div class="logo-text">
                        <h1>INGABO</h1>
                        <span>Online shop</span>
                    </div>
                </div>
                
                <div class="search-area">
                    <input type="text" class="search-bar" placeholder="What are you looking for?">
                    <button class="search-button">Search</button>
                </div>
                
                <div class="header-right">
                    <button class="cart-button">
                        <i class='bx bx-cart'></i>
                        <span>Cart</span>
                    </button>
                    <div class="auth-links">
                        <a href="#" id="loginLink"><i class='bx bx-user'></i> Login</a>
                        <a href="#" id="registerLink"><i class='bx bx-user-plus'></i> Register</a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="left-sidebar">
                <div class="category-header">Shop by Category</div>
                <ul class="category-list" id="categoryList">
                    <!-- Categories will be loaded from Firebase -->
                    <div class="loading">Loading categories...</div>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Hero Section -->
                <section class="hero-section" id="heroSection">
                    <div class="hero-overlay">
                        <div class="hero-title" id="heroTitle">Wholesale Market</div>
                        <button class="hero-button" id="heroButton">
                            GO SHOPPING <i class='bx bx-chevron-right'></i>
                        </button>
                    </div>
                    <div class="carousel-dots" id="carouselDots"></div>
                </section>
                
                <!-- Product Categories -->
                <div class="product-categories" id="productCategories">
                    <!-- Category cards will be loaded from Firebase -->
                    <div class="loading">Loading featured categories...</div>
                </div>
                
                <!-- Top Picks Section -->
                <section class="top-picks-section">
                    <div class="section-title">
                        <div class="orange-dot"></div>
                        <h2>INGABO TOP PICKS</h2>
                    </div>
                    
                    <div class="top-picks-grid" id="topPicksGrid">
                        <!-- Top picks will be loaded from Firebase -->
                        <div class="loading">Loading top picks...</div>
                    </div>
                </section>
                
                <!-- Today's Deal Section -->
                <section class="todays-deal-section">
                    <div class="section-title">
                        <div class="orange-dot"></div>
                        <h2>Personalized Recommendations</h2>
                    </div>
                    
                    <div class="deal-grid" id="dealGrid">
                        <!-- Personalized products will be loaded from Firebase -->
                        <div class="loading">Loading personalized deals...</div>
                    </div>
                    
                    <div class="navigation-button" id="nextButton"><i class='bx bx-chevron-right'></i></div>
                </section>
                
                <!-- Footer Sections -->
                <div class="footer-sections">
                    <div class="footer-columns">
                        <div class="footer-column">
                            <div class="footer-title">Subscription</div>
                            <div class="subscription-form">
                                <input type="email" class="email-input" placeholder="Please enter your email">
                                <button class="subscribe-button">Subscribe</button>
                            </div>
                            <div class="helper-text">Register now for updates on promotions and coupons</div>
                        </div>
                        
                        <div class="footer-column">
                            <div class="footer-title">Sell on INGABO</div>
                            <div class="sell-text">Join us</div>
                        </div>
                        
                        <div class="footer-column">
                            <div class="footer-title">Stay Connected</div>
                            <div class="social-icons">
                                <a href="#" class="social-icon"><i class='bx bxl-facebook'></i></a>
                                <a href="#" class="social-icon"><i class='bx bxl-twitter'></i></a>
                                <a href="#" class="social-icon"><i class='bx bxl-whatsapp'></i></a>
                                <a href="#" class="social-icon"><i class='bx bx-message-rounded'></i></a>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Links -->
                <div class="footer-links">
                    <div class="links-column">
                        <h3>FAQs</h3>
                        <ul class="links-list">
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Shipping information</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> How to buy</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> How to pay</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Return policy</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Terms</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Contact support</a></li>
                        </ul>
                    </div>
                    
                    <div class="links-column">
                        <h3>Browse by Category</h3>
                        <ul class="links-list">
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Women's Shoes</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Men's Shoes</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Dresses</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Rings</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Shoulder Bags</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Bottoms</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Hair Wear</a></li>
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Baby Kids</a></li>
                        </ul>
                    </div>
                    
                    <div class="links-column">
                        <h3>About</h3>
                        <ul class="links-list">
                            <li><a href="#"><i class='bx bx-chevron-right'></i> Privacy Policy</a></li>
                        </ul>
                    </div>
                    
                    <div class="links-column">
                        <h3>Contact Us</h3>
                        <div class="contact-info">
                            <div><i class='bx bx-map'></i> Address: Kigali, Rwanda</div>
                            <div><i class='bx bx-phone'></i> Phone: +250 788 123 456</div>
                            <div><i class='bx bx-envelope'></i> Email: info@ingabo.com</div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Right Sidebar -->
            <aside class="right-sidebar">
                <div class="account-area">
                    <img src="https://i.ibb.co/1fjd5Ncn/logo.png" alt="INGABO Logo" class="account-logo">
                    <div class="account-title" id="userGreeting">Welcome to INGABO</div>
                    <div class="account-buttons">
                        <button class="login-button" id="sidebarLogin"><i class='bx bx-user'></i> Login</button>
                        <button class="register-button" id="sidebarRegister"><i class='bx bx-user-plus'></i> Register</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAQsQAEGPdFY2gKRBpC3crZTSEzUGQ4CKE",
            authDomain: "ingabo-store.firebaseapp.com",
            projectId: "ingabo-store",
            storageBucket: "ingabo-store.firebasestorage.app",
            messagingSenderId: "1059301382626",
            appId: "1:1059301382626:web:98f0a8cebbeccbc21f41bb",
            measurementId: "G-QSXTGP9R1Q"
        };

        // Initialize Firebase (FIXED - using v8 compatibility version)
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // if already initialized, use that one
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // ==================== MOBILE REDIRECTION ====================
        function checkMobileRedirect() {
            const isMobile = /iPhone|iPad|iPod|Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isSmallScreen = window.innerWidth < 768;
            
            if (isMobile || isSmallScreen) {
                window.location.href = "indexp.html";
            }
        }

        // Check on page load and resize
        window.addEventListener('load', checkMobileRedirect);
        window.addEventListener('resize', checkMobileRedirect);

        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let userPersonalCode = '';
        let allProducts = [];
        let sitePersonalization = null;
        let currentDealPage = 0;
        const dealsPerPage = 10;

        // ==================== PERSONALIZATION ALGORITHM ====================
        // Metric mappings for Suggestion Code generation
        const metricMappings = {
            category: {
                'Shoes': 'A',
                'T-shirts': 'B',
                'Pants': 'C',
                'Watches': 'D',
                'Necklace': 'E',
                'Bracelets': 'F',
                'Caps': 'G'
            },
            department: {
                'Men': 'A',
                'Women': 'B'
            },
            color: {
                'White': 'A',
                'Black': 'B',
                'Blue': 'C',
                'Green': 'D',
                'Red': 'E',
                'Yellow': 'F',
                'Chocolate': 'G',
                'Purple': 'H',
                'Orange': 'I',
                'Sky-blue': 'J',
                'Reddish': 'K',
                'Pink': 'L'
            },
            size: {
                'Small': 'A',
                'Medium': 'B',
                'Large': 'C'
            },
            age: {
                'All': 'A',
                'Young': 'B',
                'Teens': 'C',
                'Adult': 'D',
                'Old': 'E'
            },
            status: {
                'New': 'A',
                'Used': 'B'
            },
            wealth: {
                'Poor': 'A',
                'Moderate': 'B',
                'Rich': 'C'
            }
        };

        // Generate Suggestion Code for a product
        function generateSuggestionCode(product) {
            if (!product) return 'X-X-X-X-X-X-X';
            
            let code = '';
            
            // Category
            code += (product.category && metricMappings.category[product.category]) || 'X';
            code += '-';
            
            // Department
            code += (product.department && metricMappings.department[product.department]) || 'X';
            code += '-';
            
            // Color (can have multiple)
            const colors = product.color ? (Array.isArray(product.color) ? product.color : [product.color]) : ['X'];
            code += colors.map(c => metricMappings.color[c] || 'X').join('+');
            code += '-';
            
            // Size
            code += (product.size && metricMappings.size[product.size]) || 'X';
            code += '-';
            
            // Age
            code += (product.age && metricMappings.age[product.age]) || 'X';
            code += '-';
            
            // Status
            code += (product.status && metricMappings.status[product.status]) || 'X';
            code += '-';
            
            // Wealth
            code += (product.wealth && metricMappings.wealth[product.wealth]) || 'X';
            
            return code;
        }

        // Generate Personal Code for a user
        function generatePersonalCode(userData) {
            if (!userData) return 'GUEST-CODE';
            
            let code = '';
            
            // Use gender for department preference
            if (userData.gender) {
                code += metricMappings.department[userData.gender === 'Male' ? 'Men' : 'Women'] || 'X';
            } else {
                code += 'X';
            }
            code += '-';
            
            // Use age for age preference
            if (userData.age) {
                let ageCategory = 'Adult';
                if (userData.age < 18) ageCategory = 'Teens';
                else if (userData.age < 25) ageCategory = 'Young';
                else if (userData.age > 60) ageCategory = 'Old';
                code += metricMappings.age[ageCategory] || 'X';
            } else {
                code += 'X';
            }
            code += '-';
            
            // Generate random preferences for other metrics (these would be updated based on views)
            const randomCategories = ['A', 'B', 'C', 'D'];
            code += randomCategories.join('+');
            
            return code;
        }

        // Compare user code with product suggestion code
        function calculateMatchScore(userCode, productCode) {
            if (userCode === 'GUEST-CODE' || !productCode) return 0;
            
            try {
                const userParts = userCode.split('-');
                const productParts = productCode.split('-');
                
                let score = 0;
                
                for (let i = 0; i < Math.min(userParts.length, productParts.length); i++) {
                    const userMetrics = userParts[i].split('+');
                    const productMetrics = productParts[i].split('+');
                    
                    // Check for any matching metric in this category
                    for (const userMetric of userMetrics) {
                        if (productMetrics.includes(userMetric)) {
                            score += 1;
                            break;
                        }
                    }
                }
                
                return score;
            } catch (error) {
                console.error('Error calculating match score:', error);
                return 0;
            }
        }

        // Personalized product sorting algorithm
        function sortProductsPersonalized(products, userCode) {
            if (!products || products.length === 0) return [];
            
            if (userCode === 'GUEST-CODE' || !userCode) {
                // Random fallback for guests
                return [...products].sort(() => Math.random() - 0.5);
            }
            
            try {
                // Calculate match scores
                const scoredProducts = products.map(product => {
                    const matchScore = calculateMatchScore(userCode, product.suggestionCode);
                    return { ...product, matchScore };
                });
                
                // Sort by match score (descending)
                scoredProducts.sort((a, b) => b.matchScore - a.matchScore);
                
                return scoredProducts;
            } catch (error) {
                console.error('Error sorting products:', error);
                return [...products].sort(() => Math.random() - 0.5);
            }
        }

        // ==================== FIREBASE DATA LOADING ====================
        async function loadSitePersonalization() {
            try {
                const doc = await db.collection('site_personalization').doc('settings').get();
                if (doc.exists) {
                    sitePersonalization = doc.data();
                    applySitePersonalization();
                    
                    // Listen for real-time updates
                    db.collection('site_personalization').doc('settings')
                        .onSnapshot((snapshot) => {
                            if (snapshot.exists) {
                                sitePersonalization = snapshot.data();
                                applySitePersonalization();
                            }
                        }, (error) => {
                            console.error('Error listening to site personalization:', error);
                        });
                }
            } catch (error) {
                console.error('Error loading site personalization:', error);
            }
        }

        async function loadCategories() {
            try {
                const categoryList = document.getElementById('categoryList');
                if (!categoryList) return;
                
                // Clear loading message
                categoryList.innerHTML = '';
                
                const snapshot = await db.collection('categories').orderBy('order').get();
                
                if (snapshot.empty) {
                    // Create default categories if none exist
                    const defaultCategories = [
                        { name: 'Clothing', icon: 'bx bx-t-shirt', order: 1 },
                        { name: 'Shoes', icon: 'bx bx-walk', order: 2 },
                        { name: 'Electronics', icon: 'bx bx-chip', order: 3 },
                        { name: 'Accessories', icon: 'bx bx-watch', order: 4 }
                    ];
                    
                    defaultCategories.forEach(category => {
                        const li = document.createElement('li');
                        li.className = 'category-item';
                        li.innerHTML = `
                            <i class='bx ${category.icon} category-icon'></i>
                            <span>${category.name}</span>
                        `;
                        li.addEventListener('click', () => filterByCategory(category.name));
                        categoryList.appendChild(li);
                    });
                    return;
                }
                
                snapshot.forEach(doc => {
                    const category = doc.data();
                    const li = document.createElement('li');
                    li.className = 'category-item';
                    li.innerHTML = `
                        <i class='bx ${category.icon || 'bx-category'} category-icon'></i>
                        <span>${category.name}</span>
                    `;
                    li.addEventListener('click', () => filterByCategory(category.id || category.name));
                    categoryList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
                const categoryList = document.getElementById('categoryList');
                if (categoryList) {
                    categoryList.innerHTML = '<li class="category-item">Error loading categories</li>';
                }
            }
        }

        async function loadFeaturedCategories() {
            try {
                const container = document.getElementById('productCategories');
                if (!container) return;
                
                // Clear loading message
                container.innerHTML = '';
                
                const snapshot = await db.collection('featured_categories').limit(4).get();
                
                if (snapshot.empty) {
                    // Create default featured categories
                    const defaultFeatured = [
                        { name: "Men's Shoes", imageUrl: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80' },
                        { name: "Women's Shoes", imageUrl: 'https://images.unsplash.com/photo-1543163521-1bf539c55dd2?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80' },
                        { name: "iPhone", imageUrl: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80' },
                        { name: "Accessories", imageUrl: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80' }
                    ];
                    
                    defaultFeatured.forEach((category, index) => {
                        const card = document.createElement('div');
                        card.className = 'category-card';
                        card.style.backgroundImage = `url('${category.imageUrl}')`;
                        card.innerHTML = `<div class="category-name">${category.name}</div>`;
                        card.addEventListener('click', () => filterByCategory(category.name));
                        container.appendChild(card);
                    });
                    return;
                }
                
                snapshot.forEach(doc => {
                    const category = doc.data();
                    const card = document.createElement('div');
                    card.className = 'category-card';
                    card.style.backgroundImage = `url('${category.imageUrl || 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?ixlib=rb-1.2.1&auto=format&fit=crop&w=500&q=80'}')`;
                    card.innerHTML = `<div class="category-name">${category.name}</div>`;
                    card.addEventListener('click', () => filterByCategory(category.categoryId || category.name));
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading featured categories:', error);
            }
        }

        async function loadTopPicks() {
            try {
                const container = document.getElementById('topPicksGrid');
                if (!container) return;
                
                // Clear loading message
                container.innerHTML = '';
                
                const snapshot = await db.collection('products')
                    .where('active', '==', true)
                    .where('featured', '==', true)
                    .limit(12)
                    .get();
                
                if (snapshot.empty) {
                    container.innerHTML = '<div class="top-pick-card"><div class="card-header"><div class="card-title">No featured products yet</div></div></div>';
                    return;
                }
                
                // Group products by category
                const productsByCategory = {};
                snapshot.forEach(doc => {
                    const product = doc.data();
                    product.id = doc.id;
                    
                    const category = product.category || 'Uncategorized';
                    if (!productsByCategory[category]) {
                        productsByCategory[category] = [];
                    }
                    productsByCategory[category].push(product);
                });
                
                // Create top pick cards for each category
                Object.keys(productsByCategory).forEach(category => {
                    const products = productsByCategory[category].slice(0, 5);
                    
                    const card = document.createElement('div');
                    card.className = 'top-pick-card';
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">${category}</div>
                            <a href="#" class="view-all-link" data-category="${category}">View All</a>
                        </div>
                        <div class="product-images">
                            ${products.map(product => `
                                <div class="product-image" data-product="${product.id}">
                                    ${product.images && product.images[0] ? 
                                        `<img src="${product.images[0]}" alt="${product.name || 'Product'}" loading="lazy">` : 
                                        `<i class='bx bx-image'></i>`
                                    }
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Add click events to product images
                    card.querySelectorAll('.product-image').forEach(img => {
                        img.addEventListener('click', function() {
                            const productId = this.getAttribute('data-product');
                            if (productId) {
                                window.location.href = `view.html?id=${productId}`;
                            }
                        });
                    });
                    
                    // Add click event to view all link
                    const viewAllLink = card.querySelector('.view-all-link');
                    if (viewAllLink) {
                        viewAllLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            const category = this.getAttribute('data-category');
                            filterByCategory(category);
                        });
                    }
                    
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading top picks:', error);
                const container = document.getElementById('topPicksGrid');
                if (container) {
                    container.innerHTML = '<div class="top-pick-card"><div class="card-header"><div class="card-title">Error loading products</div></div></div>';
                }
            }
        }

        async function loadPersonalizedDeals() {
            try {
                const container = document.getElementById('dealGrid');
                if (!container) return;
                
                // Clear loading message
                container.innerHTML = '<div class="loading">Loading deals...</div>';
                
                // First load all products
                const snapshot = await db.collection('products').where('active', '==', true).limit(50).get();
                allProducts = [];
                
                snapshot.forEach(doc => {
                    const product = doc.data();
                    product.id = doc.id;
                    product.suggestionCode = generateSuggestionCode(product);
                    allProducts.push(product);
                });
                
                if (allProducts.length === 0) {
                    container.innerHTML = '<div class="deal-card"><div class="deal-title">No products available yet</div></div>';
                    return;
                }
                
                // Sort products based on personalization algorithm
                const sortedProducts = sortProductsPersonalized(allProducts, userPersonalCode);
                
                // Display current page of deals
                displayDealsPage(sortedProducts);
            } catch (error) {
                console.error('Error loading personalized deals:', error);
                const container = document.getElementById('dealGrid');
                if (container) {
                    container.innerHTML = '<div class="deal-card"><div class="deal-title">Error loading products</div></div>';
                }
            }
        }

        function displayDealsPage(products) {
            const container = document.getElementById('dealGrid');
            if (!container || !products || products.length === 0) return;
            
            const startIndex = currentDealPage * dealsPerPage;
            const endIndex = startIndex + dealsPerPage;
            const pageProducts = products.slice(startIndex, endIndex);
            
            container.innerHTML = '';
            
            pageProducts.forEach((product, index) => {
                if (!product) return;
                
                const dealCard = document.createElement('div');
                dealCard.className = 'deal-card';
                dealCard.innerHTML = `
                    ${product.discount ? `<div class="discount-badge">-${product.discount}%</div>` : ''}
                    <div class="relevance-indicator ${index < 3 ? 'show' : ''}"></div>
                    <div class="deal-image">
                        ${product.images && product.images[0] ? 
                            `<img src="${product.images[0]}" alt="${product.name || 'Product'}" loading="lazy">` : 
                            `<div class="deal-img-placeholder"><i class='bx bx-image'></i></div>`
                        }
                        ${product.originalPrice ? `<div class="original-badge">Original</div>` : ''}
                    </div>
                    <div class="deal-title">${product.name || 'Unnamed Product'}</div>
                    <div class="deal-price">${formatPrice(product.price || 0)} RWF</div>
                    ${product.originalPrice ? `<div class="original-price">${formatPrice(product.originalPrice)} RWF</div>` : ''}
                `;
                
                dealCard.addEventListener('click', () => {
                    // Track product view for personalization
                    trackProductView(product.id);
                    window.location.href = `view.html?id=${product.id}`;
                });
                
                container.appendChild(dealCard);
            });
            
            // Update next button state
            const nextButton = document.getElementById('nextButton');
            if (nextButton) {
                const hasMoreProducts = (currentDealPage + 1) * dealsPerPage < products.length;
                nextButton.style.display = hasMoreProducts ? 'flex' : 'none';
            }
        }

        // ==================== HELPER FUNCTIONS ====================
        function formatPrice(price) {
            if (!price) return '0';
            return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function filterByCategory(category) {
            // This would filter products by category
            console.log('Filtering by category:', category);
            // In a full implementation, this would update the product display
            // For now, redirect to view page with category filter
            window.location.href = `view.html?category=${encodeURIComponent(category)}`;
        }

        async function trackProductView(productId) {
            if (!currentUser || !productId) return;
            
            try {
                await db.collection('user_activity').add({
                    userId: currentUser.uid,
                    productId: productId,
                    type: 'view',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update user's personal code based on viewing history
                updateUserPersonalCode();
            } catch (error) {
                console.error('Error tracking product view:', error);
            }
        }

        async function updateUserPersonalCode() {
            if (!currentUser) return;
            
            try {
                // Get user's viewing history
                const snapshot = await db.collection('user_activity')
                    .where('userId', '==', currentUser.uid)
                    .where('type', '==', 'view')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();
                
                // Analyze viewing patterns to update preferences
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userPersonalCode = generatePersonalCode(userData);
                }
            } catch (error) {
                console.error('Error updating personal code:', error);
            }
        }

        // ==================== SITE PERSONALIZATION ====================
        function applySitePersonalization() {
            if (!sitePersonalization) return;
            
            // Apply background image
            if (sitePersonalization.backgroundImage) {
                document.body.style.backgroundImage = `url('${sitePersonalization.backgroundImage}')`;
                document.body.style.backgroundSize = 'cover';
                document.body.style.backgroundAttachment = 'fixed';
            }
            
            // Apply accent color
            if (sitePersonalization.accentColor) {
                const accentColor = sitePersonalization.accentColor;
                
                // Update all elements with accent color
                const elementsToUpdate = [
                    '.category-header',
                    '.hero-button',
                    '.search-button',
                    '.login-button',
                    '.subscribe-button',
                    '.original-badge'
                ];
                
                elementsToUpdate.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        if (el) el.style.backgroundColor = accentColor;
                    });
                });
                
                // Update orange dot
                document.querySelectorAll('.orange-dot').forEach(el => {
                    if (el) el.style.backgroundColor = accentColor;
                });
            }
            
            // Apply announcements
            const announcementBanner = document.getElementById('announcementBanner');
            const announcementContent = document.getElementById('announcementContent');
            
            if (announcementBanner && announcementContent) {
                if (sitePersonalization.announcements && sitePersonalization.announcements.length > 0) {
                    const activeAnnouncement = sitePersonalization.announcements.find(a => a.active);
                    if (activeAnnouncement) {
                        announcementContent.innerHTML = activeAnnouncement.content;
                        announcementBanner.classList.add('show');
                    } else {
                        announcementBanner.classList.remove('show');
                    }
                } else {
                    announcementBanner.classList.remove('show');
                }
            }
            
            // Apply website status
            const pausedOverlay = document.getElementById('pausedOverlay');
            if (pausedOverlay) {
                if (sitePersonalization.status === 'PAUSED') {
                    pausedOverlay.classList.add('active');
                    document.body.style.filter = 'grayscale(100%)';
                    
                    // Disable interactive elements
                    document.querySelectorAll('button, a, input').forEach(el => {
                        if (el) {
                            el.style.pointerEvents = 'none';
                            el.style.opacity = '0.6';
                        }
                    });
                } else {
                    pausedOverlay.classList.remove('active');
                    document.body.style.filter = 'none';
                    
                    // Re-enable interactive elements
                    document.querySelectorAll('button, a, input').forEach(el => {
                        if (el) {
                            el.style.pointerEvents = 'auto';
                            el.style.opacity = '1';
                        }
                    });
                }
            }
            
            // Apply hero section customization
            const heroSection = document.getElementById('heroSection');
            const heroTitle = document.getElementById('heroTitle');
            
            if (sitePersonalization.heroImage && heroSection) {
                heroSection.style.backgroundImage = `url('${sitePersonalization.heroImage}')`;
            }
            
            if (sitePersonalization.heroTitle && heroTitle) {
                heroTitle.textContent = sitePersonalization.heroTitle;
            }
        }

        // ==================== AUTHENTICATION ====================
        function setupAuth() {
            // Check current auth state
            auth.onAuthStateChanged(async (user) => {
                currentUser = user;
                
                const userGreeting = document.getElementById('userGreeting');
                const loginLink = document.getElementById('loginLink');
                const sidebarLogin = document.getElementById('sidebarLogin');
                
                if (user) {
                    // User is signed in
                    if (userGreeting) userGreeting.textContent = `Welcome, ${user.displayName || user.email || 'User'}`;
                    if (loginLink) loginLink.innerHTML = `<i class='bx bx-user'></i> ${user.displayName || user.email || 'Account'}`;
                    if (sidebarLogin) sidebarLogin.innerHTML = `<i class='bx bx-user'></i> Account`;
                    
                    // Load user data and generate personal code
                    try {
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            userPersonalCode = generatePersonalCode(userData);
                        } else {
                            userPersonalCode = 'GUEST-CODE';
                        }
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        userPersonalCode = 'GUEST-CODE';
                    }
                } else {
                    // User is signed out
                    if (userGreeting) userGreeting.textContent = 'Welcome to INGABO';
                    if (loginLink) loginLink.innerHTML = '<i class=\'bx bx-user\'></i> Login';
                    if (sidebarLogin) sidebarLogin.innerHTML = '<i class=\'bx bx-user\'></i> Login';
                    userPersonalCode = 'GUEST-CODE';
                }
                
                // Load personalized deals with updated user code
                loadPersonalizedDeals();
            });
            
            // Setup login buttons
            const loginButtons = document.querySelectorAll('#loginLink, #sidebarLogin');
            loginButtons.forEach(button => {
                if (button) {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (currentUser) {
                            // Already logged in, go to account page
                            window.location.href = 'settings.html';
                        } else {
                            window.location.href = 'login.html';
                        }
                    });
                }
            });
            
            // Setup register buttons
            const registerButtons = document.querySelectorAll('#registerLink, #sidebarRegister');
            registerButtons.forEach(button => {
                if (button) {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = 'login.html?register=true';
                    });
                }
            });
        }

        // ==================== EVENT LISTENERS ====================
        function setupEventListeners() {
            // Next button for deals
            const nextButton = document.getElementById('nextButton');
            if (nextButton) {
                nextButton.addEventListener('click', () => {
                    currentDealPage++;
                    loadPersonalizedDeals();
                });
            }

            // Hero button
            const heroButton = document.getElementById('heroButton');
            if (heroButton) {
                heroButton.addEventListener('click', () => {
                    window.location.href = 'view.html?category=featured';
                });
            }

            // Search functionality
            const searchButton = document.querySelector('.search-button');
            const searchBar = document.querySelector('.search-bar');
            
            if (searchButton) {
                searchButton.addEventListener('click', performSearch);
            }
            
            if (searchBar) {
                searchBar.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') performSearch();
                });
            }
        }

        function performSearch() {
            const searchBar = document.querySelector('.search-bar');
            const query = searchBar ? searchBar.value.trim() : '';
            if (query) {
                window.location.href = `view.html?search=${encodeURIComponent(query)}`;
            }
        }

        // ==================== INITIALIZATION ====================
        async function initializeApp() {
            console.log('Initializing INGABO Store...');
            
            // Check mobile redirection
            checkMobileRedirect();
            
            // Setup authentication
            setupAuth();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load site personalization
            await loadSitePersonalization();
            
            // Load categories and featured content
            try {
                await Promise.all([
                    loadCategories(),
                    loadFeaturedCategories(),
                    loadTopPicks()
                ]);
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
            
            // Initialize analytics
            try {
                analytics.logEvent('page_view', {
                    page_title: 'Homepage',
                    page_location: window.location.href
                });
            } catch (error) {
                console.error('Error logging analytics:', error);
            }
            
            console.log('INGABO Store initialized successfully');
        }

        // Start the application
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
