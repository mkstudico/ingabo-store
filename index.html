<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>INGABO Online Shop</title>
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase v8 for compatibility -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        :root {
            --primary-color: #ff6a00;
            --secondary-color: #ff8c42;
            --text-dark: #333;
            --text-light: #666;
            --text-lighter: #888;
            --bg-light: #f9f9f9;
            --bg-white: #ffffff;
            --border-color: #e5e5e5;
            --shadow: 0 2px 10px rgba(0,0,0,0.05);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ========== HEADER & NAVIGATION ========== */
        .top-header {
            background-color: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: var(--shadow);
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
        }
        
        .logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .logo-text h1 {
            font-size: 22px;
            font-weight: 700;
            color: #000;
            line-height: 1;
        }
        
        .logo-text span {
            font-size: 11px;
            color: var(--text-lighter);
        }
        
        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-bar {
            width: 100%;
            padding: 12px 20px;
            padding-right: 45px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 14px;
            background: var(--bg-light);
            transition: var(--transition);
        }
        
        .search-bar:focus {
            outline: none;
            border-color: var(--primary-color);
            background: var(--bg-white);
            box-shadow: 0 0 0 3px rgba(255, 106, 0, 0.1);
        }
        
        .search-button {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            height: 36px;
            width: 36px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .search-button:hover {
            background-color: var(--secondary-color);
        }
        
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-white);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }
        
        .search-suggestions.active {
            display: block;
        }
        
        .suggestion-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }
        
        .suggestion-item:hover {
            background-color: var(--bg-light);
        }
        
        .suggestion-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .suggestion-info {
            flex: 1;
        }
        
        .suggestion-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .suggestion-price {
            font-size: 13px;
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .cart-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: var(--bg-white);
            color: var(--text-dark);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            padding: 8px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .cart-button:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .auth-links {
            display: flex;
            gap: 15px;
        }
        
        .auth-links a {
            color: var(--text-dark);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }
        
        .auth-links a:hover {
            color: var(--primary-color);
        }
        
        /* ========== BREADCRUMB NAVIGATION ========== */
        .breadcrumb {
            background: var(--bg-white);
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            display: none;
        }
        
        .breadcrumb.active {
            display: block;
        }
        
        .breadcrumb-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .breadcrumb-item:hover {
            color: var(--primary-color);
        }
        
        .breadcrumb-item.active {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .breadcrumb-separator {
            color: var(--text-lighter);
        }
        
        /* ========== MAIN LAYOUT ========== */
        .main-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 25px;
            margin-top: 20px;
        }
        
        /* ========== SIDEBAR - CATEGORIES ========== */
        .sidebar {
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            height: fit-content;
            position: sticky;
            top: 90px;
        }
        
        .category-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 18px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }
        
        .category-list {
            list-style: none;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .category-item:hover {
            background-color: var(--bg-light);
            color: var(--primary-color);
        }
        
        .category-item.active {
            background-color: rgba(255, 106, 0, 0.1);
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .category-icon {
            font-size: 18px;
            color: inherit;
            width: 24px;
            text-align: center;
        }
        
        .category-name {
            flex: 1;
            font-size: 14px;
        }
        
        .category-count {
            background: var(--bg-light);
            color: var(--text-light);
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        /* ========== HERO SECTION ========== */
        .hero-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 8px;
            padding: 40px;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            align-items: center;
        }
        
        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 600px;
        }
        
        .hero-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.2;
        }
        
        .hero-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 25px;
        }
        
        .hero-button {
            background: white;
            color: var(--primary-color);
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .hero-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        /* ========== FEATURED CATEGORIES ========== */
        .featured-categories {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
        }
        
        .featured-category-card {
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .featured-category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .category-image {
            height: 120px;
            overflow: hidden;
        }
        
        .category-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }
        
        .featured-category-card:hover .category-image img {
            transform: scale(1.05);
        }
        
        .category-info {
            padding: 15px;
        }
        
        .category-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 5px;
        }
        
        .category-product-count {
            font-size: 12px;
            color: var(--text-lighter);
        }
        
        /* ========== TOP PICKS SECTION ========== */
        .top-picks-section {
            background: var(--bg-white);
            border-radius: 8px;
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-icon {
            width: 12px;
            height: 12px;
            background: var(--primary-color);
            border-radius: 50%;
        }
        
        .section-title h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .view-all-link {
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .top-picks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .top-pick-category {
            background: var(--bg-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            transition: var(--transition);
        }
        
        .top-pick-category:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(255, 106, 0, 0.1);
        }
        
        .category-header-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .category-title-mini {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .category-products {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        
        .category-product {
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .category-product img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }
        
        .category-product:hover img {
            transform: scale(1.1);
        }
        
        /* ========== PRODUCTS GRID ========== */
        .products-section {
            display: none;
        }
        
        .products-section.active {
            display: block;
        }
        
        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .products-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .products-count {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .product-card {
            background: var(--bg-white);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .product-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #ff0000;
            color: white;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            z-index: 2;
        }
        
        .product-image {
            height: 180px;
            overflow: hidden;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: var(--transition);
        }
        
        .product-card:hover .product-image img {
            transform: scale(1.05);
        }
        
        .product-info {
            padding: 15px;
        }
        
        .product-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 8px;
            line-height: 1.4;
            height: 40px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-price {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .product-original-price {
            font-size: 13px;
            color: var(--text-lighter);
            text-decoration: line-through;
        }
        
        .product-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
            margin-top: 10px;
        }
        
        /* ========== LOADING STATES ========== */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 48px;
            color: var(--border-color);
            margin-bottom: 15px;
        }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: static;
                margin-bottom: 20px;
            }
            
            .category-list {
                max-height: 300px;
            }
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }
            
            .search-container {
                order: 3;
                max-width: 100%;
                margin-top: 10px;
            }
            
            .top-picks-grid,
            .products-grid,
            .featured-categories {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .hero-section {
                padding: 30px 20px;
            }
            
            .hero-title {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 15px;
            }
            
            .top-picks-grid,
            .products-grid,
            .featured-categories {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .category-products {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header-right {
                gap: 10px;
            }
            
            .cart-button span {
                display: none;
            }
            
            .auth-links a span {
                display: none;
            }
        }
        
        /* ========== UTILITY CLASSES ========== */
        .hidden {
            display: none !important;
        }
        
        .active {
            display: block !important;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <!-- Paused Mode Overlay -->
    <div class="paused-overlay" id="pausedOverlay">
        <div>WEBSITE IS TEMPORARILY PAUSED. PLEASE CHECK BACK SOON.</div>
    </div>
    
    <!-- Announcement Banner -->
    <div class="announcement-banner" id="announcementBanner">
        <div class="announcement-content" id="announcementContent"></div>
    </div>
    
    <div class="container">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-content">
                <a href="#" class="logo-area" id="logoLink">
                    <img src="https://i.ibb.co/1fjd5Ncn/logo.png" alt="INGABO Logo" class="logo-img">
                    <div class="logo-text">
                        <h1>INGABO</h1>
                        <span>Online shop</span>
                    </div>
                </a>
                
                <div class="search-container">
                    <div class="search-wrapper">
                        <input type="text" class="search-bar" id="searchBar" placeholder="Search for products, categories, brands...">
                        <button class="search-button" id="searchButton">
                            <i class='bx bx-search'></i>
                        </button>
                        <div class="search-suggestions" id="searchSuggestions">
                            <!-- Search suggestions will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="header-right">
                    <button class="cart-button">
                        <i class='bx bx-cart'></i>
                        <span>Cart</span>
                    </button>
                    <div class="auth-links">
                        <a href="#" id="loginLink"><i class='bx bx-user'></i> <span>Login</span></a>
                        <a href="#" id="registerLink"><i class='bx bx-user-plus'></i> <span>Register</span></a>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb" id="breadcrumb">
            <div class="breadcrumb-content">
                <div class="breadcrumb-item" id="homeBreadcrumb">
                    <i class='bx bx-home'></i>
                    <span>Home</span>
                </div>
                <div class="breadcrumb-separator">/</div>
                <div class="breadcrumb-item" id="currentBreadcrumb">
                    <span>All Products</span>
                </div>
            </div>
        </div>
        
        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar - Categories -->
            <aside class="sidebar">
                <div class="category-header">Shop by Category</div>
                <ul class="category-list" id="categoryList">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div>Loading categories...</div>
                    </div>
                </ul>
            </aside>
            
            <!-- Main Content -->
            <main class="main-content">
                <!-- Hero Section (Default View) -->
                <section class="hero-section" id="heroSection">
                    <div class="hero-content">
                        <h1 class="hero-title">Wholesale Market</h1>
                        <p class="hero-subtitle">Discover amazing products at wholesale prices. Quality guaranteed with personalized recommendations just for you.</p>
                        <button class="hero-button" id="heroButton">
                            Start Shopping <i class='bx bx-chevron-right'></i>
                        </button>
                    </div>
                </section>
                
                <!-- Featured Categories (Default View) -->
                <section class="featured-categories-section" id="featuredCategoriesSection">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon"></div>
                            <h2>Featured Categories</h2>
                        </div>
                    </div>
                    <div class="featured-categories" id="featuredCategories">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>Loading categories...</div>
                        </div>
                    </div>
                </section>
                
                <!-- Top Picks Section (Default View) -->
                <section class="top-picks-section" id="topPicksSection">
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon"></div>
                            <h2>INGABO TOP PICKS</h2>
                        </div>
                        <a href="#" class="view-all-link" id="viewAllTopPicks">
                            View All <i class='bx bx-chevron-right'></i>
                        </a>
                    </div>
                    <div class="top-picks-grid" id="topPicksGrid">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <div>Loading top picks...</div>
                        </div>
                    </div>
                </section>
                
                <!-- Products Grid (Filtered/Search View) -->
                <section class="products-section" id="productsSection">
                    <div class="products-header">
                        <div>
                            <h2 class="products-title" id="productsTitle">Products</h2>
                            <div class="products-count" id="productsCount">0 products found</div>
                        </div>
                    </div>
                    <div class="products-grid" id="productsGrid">
                        <!-- Products will be populated here -->
                    </div>
                    <div class="empty-state hidden" id="emptyProducts">
                        <i class='bx bx-package'></i>
                        <h3>No products found</h3>
                        <p>Try adjusting your search or filter criteria</p>
                    </div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAQsQAEGPdFY2gKRBpC3crZTSEzUGQ4CKE",
            authDomain: "ingabo-store.firebaseapp.com",
            projectId: "ingabo-store",
            storageBucket: "ingabo-store.firebasestorage.app",
            messagingSenderId: "1059301382626",
            appId: "1:1059301382626:web:98f0a8cebbeccbc21f41bb",
            measurementId: "G-QSXTGP9R1Q"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let userPersonalCode = '';
        let userTrackingData = [];
        let allProducts = [];
        let allCategories = [];
        let featuredCategories = [];
        let sitePersonalization = null;
        let currentCategory = null;
        let currentSearch = '';
        let searchTimeout = null;

        // ==================== PERSONALIZATION ALGORITHM ====================
        // Metric mappings for Suggestion Code generation
        const metricMappings = {
            category: {
                'Shoes': 'A', 'T-shirts': 'B', 'Pants': 'C',
                'Watches': 'D', 'Necklace': 'E', 'Bracelets': 'F', 'Caps': 'G'
            },
            department: { 'Men': 'A', 'Women': 'B' },
            color: {
                'White': 'A', 'Black': 'B', 'Blue': 'C', 'Green': 'D',
                'Red': 'E', 'Yellow': 'F', 'Chocolate': 'G', 'Purple': 'H',
                'Orange': 'I', 'Sky-blue': 'J', 'Reddish': 'K', 'Pink': 'L'
            },
            size: { 'Small': 'A', 'Medium': 'B', 'Large': 'C' },
            age: { 'All': 'A', 'Young': 'B', 'Teens': 'C', 'Adult': 'D', 'Old': 'E' },
            status: { 'New': 'A', 'Used': 'B' },
            wealth: { 'Poor': 'A', 'Moderate': 'B', 'Rich': 'C' }
        };

        // Generate Suggestion Code for a product
        function generateSuggestionCode(product) {
            if (!product) return 'X-X-X-X-X-X-X';
            
            let code = '';
            
            // Category
            code += (product.category && metricMappings.category[product.category]) || 'X';
            code += '-';
            
            // Department
            const department = Array.isArray(product.department) ? product.department[0] : product.department;
            code += (department && metricMappings.department[department]) || 'X';
            code += '-';
            
            // Color (can have multiple)
            const colors = product.color ? (Array.isArray(product.color) ? product.color : [product.color]) : ['X'];
            code += colors.map(c => metricMappings.color[c] || 'X').join('+');
            code += '-';
            
            // Size (can have multiple)
            const sizes = product.size ? (Array.isArray(product.size) ? product.size : [product.size]) : ['X'];
            code += sizes.map(s => metricMappings.size[s] || 'X').join('+');
            code += '-';
            
            // Age (can have multiple)
            const ages = product.age ? (Array.isArray(product.age) ? product.age : [product.age]) : ['X'];
            code += ages.map(a => metricMappings.age[a] || 'X').join('+');
            code += '-';
            
            // Status (can have multiple)
            const statuses = product.status ? (Array.isArray(product.status) ? product.status : [product.status]) : ['X'];
            code += statuses.map(s => metricMappings.status[s] || 'X').join('+');
            code += '-';
            
            // Wealth
            code += (product.wealth && metricMappings.wealth[product.wealth]) || 'X';
            
            return code;
        }

        // Generate Personal Code for a user
        function generatePersonalCode(userData) {
            if (!userData) {
                // Try to get from localStorage
                const storedData = localStorage.getItem('ingabo_guest_data');
                if (storedData) {
                    try {
                        userData = JSON.parse(storedData);
                    } catch (e) {
                        return 'GUEST-CODE';
                    }
                } else {
                    return 'GUEST-CODE';
                }
            }
            
            let code = '';
            
            // Use gender for department preference
            if (userData.gender) {
                code += metricMappings.department[userData.gender === 'Male' ? 'Men' : 'Women'] || 'X';
            } else {
                code += 'X';
            }
            code += '-';
            
            // Use age for age preference
            if (userData.age) {
                let ageCategory = 'Adult';
                const age = parseInt(userData.age);
                if (age < 18) ageCategory = 'Teens';
                else if (age < 25) ageCategory = 'Young';
                else if (age > 60) ageCategory = 'Old';
                code += metricMappings.age[ageCategory] || 'X';
            } else {
                code += 'X';
            }
            code += '-';
            
            // Generate preferences based on viewing history
            const viewingHistory = getViewingHistory();
            if (viewingHistory.length > 0) {
                const colorPreferences = viewingHistory.map(item => item.color).flat().filter(Boolean);
                const uniqueColors = [...new Set(colorPreferences)];
                if (uniqueColors.length > 0) {
                    code += uniqueColors.map(c => metricMappings.color[c] || 'X').slice(0, 3).join('+');
                } else {
                    code += 'X';
                }
            } else {
                code += 'X';
            }
            
            return code;
        }

        // Compare user code with product suggestion code
        function calculateMatchScore(userCode, productCode) {
            if (userCode === 'GUEST-CODE' || !productCode) return 0;
            
            try {
                const userParts = userCode.split('-');
                const productParts = productCode.split('-');
                
                let score = 0;
                
                for (let i = 0; i < Math.min(userParts.length, productParts.length); i++) {
                    const userMetrics = userParts[i].split('+');
                    const productMetrics = productParts[i].split('+');
                    
                    // Check for any matching metric in this category
                    for (const userMetric of userMetrics) {
                        if (productMetrics.includes(userMetric)) {
                            score += 1;
                            break;
                        }
                    }
                }
                
                return score;
            } catch (error) {
                console.error('Error calculating match score:', error);
                return 0;
            }
        }

        // Personalized product sorting algorithm
        function sortProductsPersonalized(products, userCode) {
            if (!products || products.length === 0) return [];
            
            if (userCode === 'GUEST-CODE' || !userCode) {
                // Random fallback for guests
                return [...products].sort(() => Math.random() - 0.5);
            }
            
            try {
                // Calculate match scores
                const scoredProducts = products.map(product => {
                    const matchScore = calculateMatchScore(userCode, product.suggestionCode);
                    return { ...product, matchScore };
                });
                
                // Sort by match score (descending), then random for same scores
                scoredProducts.sort((a, b) => {
                    if (b.matchScore !== a.matchScore) {
                        return b.matchScore - a.matchScore;
                    }
                    return Math.random() - 0.5;
                });
                
                return scoredProducts;
            } catch (error) {
                console.error('Error sorting products:', error);
                return [...products].sort(() => Math.random() - 0.5);
            }
        }

        // ==================== USER TRACKING & LOCAL STORAGE ====================
        function getViewingHistory() {
            try {
                const history = localStorage.getItem('ingabo_viewing_history');
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        function addToViewingHistory(product) {
            try {
                const history = getViewingHistory();
                const existingIndex = history.findIndex(item => item.productId === product.id);
                
                if (existingIndex > -1) {
                    history.splice(existingIndex, 1);
                }
                
                history.unshift({
                    productId: product.id,
                    category: product.category,
                    color: product.color || [],
                    timestamp: new Date().toISOString()
                });
                
                // Keep only last 50 items
                if (history.length > 50) {
                    history.pop();
                }
                               localStorage.setItem('ingabo_viewing_history', JSON.stringify(history));
                updateUserPersonalization();
            } catch (e) {
                console.error('Error adding to viewing history:', e);
            }
        }

        function updateUserPersonalization() {
            // Update user's personal code based on viewing history
            const viewingHistory = getViewingHistory();
            
            if (viewingHistory.length === 0) {
                userPersonalCode = 'GUEST-CODE';
                return;
            }
            
            // Extract preferences from viewing history
            const preferences = {
                categories: {},
                colors: {},
                departments: {},
                priceRange: { min: Infinity, max: 0 }
            };
            
            viewingHistory.forEach(item => {
                // Track category preferences
                if (item.category) {
                    preferences.categories[item.category] = (preferences.categories[item.category] || 0) + 1;
                }
                
                // Track color preferences
                if (item.color && Array.isArray(item.color)) {
                    item.color.forEach(color => {
                        preferences.colors[color] = (preferences.colors[color] || 0) + 1;
                    });
                }
                
                // Track department preferences
                if (item.department) {
                    preferences.departments[item.department] = (preferences.departments[item.department] || 0) + 1;
                }
                
                // Track price range
                if (item.price) {
                    preferences.priceRange.min = Math.min(preferences.priceRange.min, item.price);
                    preferences.priceRange.max = Math.max(preferences.priceRange.max, item.price);
                }
            });
            
            // Generate enhanced personal code
            userPersonalCode = generateEnhancedPersonalCode(preferences);
            
            // If user is authenticated, update in Firestore
            if (currentUser) {
                updateUserInFirestore(preferences);
            }
        }

        function generateEnhancedPersonalCode(preferences) {
            let code = '';
            
            // Department (based on most viewed)
            const topDepartment = Object.keys(preferences.departments)
                .sort((a, b) => preferences.departments[b] - preferences.departments[a])[0];
            code += (topDepartment && metricMappings.department[topDepartment]) || 'X';
            code += '-';
            
            // Color (top 3 most viewed colors)
            const topColors = Object.keys(preferences.colors)
                .sort((a, b) => preferences.colors[b] - preferences.colors[a])
                .slice(0, 3);
            if (topColors.length > 0) {
                code += topColors.map(c => metricMappings.color[c] || 'X').join('+');
            } else {
                code += 'X';
            }
            code += '-';
            
            // Age preference (inferred from viewing patterns)
            // For now, default to Adult
            code += metricMappings.age['Adult'] || 'X';
            code += '-';
            
            // Status preference (assume New based on viewing)
            code += metricMappings.status['New'] || 'X';
            code += '-';
            
            // Wealth preference (based on price range)
            const avgPrice = (preferences.priceRange.min + preferences.priceRange.max) / 2;
            let wealthCategory = 'Moderate';
            if (avgPrice <= 20000) wealthCategory = 'Poor';
            else if (avgPrice > 50000) wealthCategory = 'Rich';
            code += metricMappings.wealth[wealthCategory] || 'X';
            
            return code;
        }

        async function updateUserInFirestore(preferences) {
            if (!currentUser) return;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    preferences: preferences,
                    personalCode: userPersonalCode,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error updating user preferences:', error);
            }
        }

        // ==================== PRODUCT RECOMMENDATION ALGORITHM ====================
        function getPersonalizedRecommendations(limit = 12) {
            if (!allProducts || allProducts.length === 0) return [];
            
            // Get viewing history
            const viewingHistory = getViewingHistory();
            
            if (viewingHistory.length === 0 || userPersonalCode === 'GUEST-CODE') {
                // Random fallback
                return getRandomProducts(limit);
            }
            
            // Calculate similarity scores for all products
            const scoredProducts = allProducts.map(product => {
                // Skip products already viewed
                if (viewingHistory.some(item => item.productId === product.id)) {
                    return { ...product, similarityScore: -1 };
                }
                
                const similarityScore = calculateProductSimilarity(product, viewingHistory);
                return { ...product, similarityScore };
            });
            
            // Sort by similarity score (descending)
            scoredProducts.sort((a, b) => b.similarityScore - a.similarityScore);
            
            // Get top recommendations
            const recommendations = scoredProducts
                .filter(p => p.similarityScore > 0)
                .slice(0, limit);
            
            // If not enough recommendations, fill with random products
            if (recommendations.length < limit) {
                const remaining = limit - recommendations.length;
                const randomProducts = getRandomProducts(remaining, recommendations.map(p => p.id));
                recommendations.push(...randomProducts);
            }
            
            return recommendations;
        }

        function calculateProductSimilarity(product, viewingHistory) {
            let score = 0;
            const weights = {
                category: 3,
                department: 2,
                color: 1.5,
                price: 1,
                status: 0.5
            };
            
            // Calculate average preferences from viewing history
            const avgPreferences = {
                category: {},
                department: {},
                color: {},
                priceRange: { min: Infinity, max: 0 },
                status: {}
            };
            
            viewingHistory.forEach(item => {
                if (item.category) {
                    avgPreferences.category[item.category] = (avgPreferences.category[item.category] || 0) + 1;
                }
                if (item.department) {
                    avgPreferences.department[item.department] = (avgPreferences.department[item.department] || 0) + 1;
                }
                if (item.color) {
                    const colors = Array.isArray(item.color) ? item.color : [item.color];
                    colors.forEach(color => {
                        avgPreferences.color[color] = (avgPreferences.color[color] || 0) + 1;
                    });
                }
                if (item.price) {
                    avgPreferences.priceRange.min = Math.min(avgPreferences.priceRange.min, item.price);
                    avgPreferences.priceRange.max = Math.max(avgPreferences.priceRange.max, item.price);
                }
                if (item.status) {
                    avgPreferences.status[item.status] = (avgPreferences.status[item.status] || 0) + 1;
                }
            });
            
            // Category match
            if (product.category && avgPreferences.category[product.category]) {
                score += weights.category * (avgPreferences.category[product.category] / viewingHistory.length);
            }
            
            // Department match
            const productDepartments = Array.isArray(product.department) ? product.department : [product.department];
            productDepartments.forEach(dept => {
                if (dept && avgPreferences.department[dept]) {
                    score += weights.department * (avgPreferences.department[dept] / viewingHistory.length);
                }
            });
            
            // Color match
            const productColors = Array.isArray(product.color) ? product.color : [product.color];
            productColors.forEach(color => {
                if (color && avgPreferences.color[color]) {
                    score += weights.color * (avgPreferences.color[color] / viewingHistory.length);
                }
            });
            
            // Price similarity (within 20% of average range)
            const avgPrice = (avgPreferences.priceRange.min + avgPreferences.priceRange.max) / 2;
            const priceDiff = Math.abs(product.price - avgPrice) / avgPrice;
            if (priceDiff <= 0.2) {
                score += weights.price * (1 - priceDiff);
            }
            
            // Status match
            const productStatuses = Array.isArray(product.status) ? product.status : [product.status];
            productStatuses.forEach(status => {
                if (status && avgPreferences.status[status]) {
                    score += weights.status * (avgPreferences.status[status] / viewingHistory.length);
                }
            });
            
            // Suggestion code match
            const codeMatchScore = calculateMatchScore(userPersonalCode, product.suggestionCode);
            score += codeMatchScore * 2;
            
            return score;
        }

        function getRandomProducts(count, excludeIds = []) {
            const availableProducts = allProducts.filter(p => !excludeIds.includes(p.id));
            
            // Fisher-Yates shuffle
            const shuffled = [...availableProducts];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled.slice(0, count);
        }

        // ==================== REAL-TIME UPDATES ====================
        function initializeRealtimeUpdates() {
            // Listen for site personalization changes
            db.collection('site_personalization').doc('config')
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        sitePersonalization = doc.data();
                        applySitePersonalization();
                    }
                });
            
            // Listen for product changes
            db.collection('products')
                .where('active', '==', true)
                .onSnapshot((snapshot) => {
                    const changes = snapshot.docChanges();
                    if (changes.length > 0) {
                        // Update products
                        allProducts = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        // Re-process categories
                        processCategories();
                        
                        // Update current view if needed
                        if (currentCategory) {
                            if (currentCategory === 'all') {
                                showAllProducts();
                            } else {
                                showProductsByCategory(currentCategory);
                            }
                        } else if (currentSearch) {
                            performSearch(currentSearch);
                        }
                    }
                });
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Initializing INGABO Store...');
            
            // Initialize Firebase
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            
            // Load site personalization
            await loadSitePersonalization();
            
            // Initialize authentication
            initializeAuth();
            
            // Load products
            await loadAllProducts();
            
            // Initialize search
            initializeSearch();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Initialize real-time updates
            initializeRealtimeUpdates();
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const categoryParam = urlParams.get('category');
            const searchParam = urlParams.get('search');
            
            if (categoryParam) {
                showProductsByCategory(categoryParam);
            } else if (searchParam) {
                document.getElementById('searchBar').value = searchParam;
                performSearch(searchParam);
            }
            
            // Display personalized recommendations in a dedicated section
            displayPersonalizedRecommendations();
            
            console.log('INGABO Store initialized successfully!');
        });

        // ==================== PERSONALIZED RECOMMENDATIONS DISPLAY ====================
        function displayPersonalizedRecommendations() {
            const recommendations = getPersonalizedRecommendations(8);
            
            // Create recommendations section if it doesn't exist
            let recSection = document.getElementById('personalizedRecommendations');
            if (!recSection) {
                recSection = document.createElement('section');
                recSection.id = 'personalizedRecommendations';
                recSection.className = 'products-section';
                recSection.innerHTML = `
                    <div class="section-header">
                        <div class="section-title">
                            <div class="section-icon" style="background: #28a745;"></div>
                            <h2>Recommended For You</h2>
                        </div>
                    </div>
                    <div class="products-grid" id="recommendationsGrid"></div>
                    <div class="empty-state hidden" id="emptyRecommendations">
                        <i class='bx bx-star'></i>
                        <h3>No recommendations yet</h3>
                        <p>Start browsing products to get personalized recommendations</p>
                    </div>
                `;
                
                // Insert after top picks section
                const topPicksSection = document.getElementById('topPicksSection');
                if (topPicksSection) {
                    topPicksSection.parentNode.insertBefore(recSection, topPicksSection.nextSibling);
                }
            }
            
            const container = document.getElementById('recommendationsGrid');
            const emptyState = document.getElementById('emptyRecommendations');
            
            if (recommendations.length === 0) {
                if (container) container.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                return;
            }
            
            if (emptyState) emptyState.classList.add('hidden');
            
            if (container) {
                container.innerHTML = recommendations.map(product => {
                    const mainImage = product.images?.[0] || 'https://via.placeholder.com/300x200?text=No+Image';
                    const discount = product.discount ? Math.round(product.discount) : 0;
                    
                    return `
                        <div class="product-card" data-product-id="${product.id}">
                            ${discount > 0 ? `<div class="product-badge">${discount}% OFF</div>` : ''}
                            <div class="product-image">
                                <img src="${mainImage}" 
                                     alt="${product.name}"
                                     onerror="this.src='https://via.placeholder.com/300x200?text=Product'">
                            </div>
                            <div class="product-info">
                                <div class="product-name">${product.name}</div>
                                <div class="product-price">${formatPrice(product.price)} RWF</div>
                                <div class="product-meta">
                                    <span>${product.category || 'Uncategorized'}</span>
                                    <span><i class='bx bx-star' style="color: #ffc107;"></i> Recommended</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Add click events
                document.querySelectorAll('#recommendationsGrid .product-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const productId = this.dataset.productId;
                        viewProduct(productId);
                    });
                });
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        // ==================== OFFLINE SUPPORT ====================
        function initializeOfflineSupport() {
            // Check if browser supports service workers
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').then(registration => {
                        console.log('ServiceWorker registration successful');
                    }).catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
            
            // Cache critical assets
            const criticalAssets = [
                'https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css',
                'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap',
                'https://i.ibb.co/1fjd5Ncn/logo.png'
            ];
            
            // Preload critical assets
            criticalAssets.forEach(asset => {
                const link = document.createElement('link');
                link.rel = 'preload';
                link.as = asset.includes('.css') ? 'style' : 'image';
                link.href = asset;
                document.head.appendChild(link);
            });
        }

        // Initialize offline support
        initializeOfflineSupport();
    </script>
</body>
</html>
